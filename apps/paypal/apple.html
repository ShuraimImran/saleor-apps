<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Apple Pay Checkout — Integration Reference</title>
  <!-- Apple Pay JS SDK -->
  <script src="https://applepay.cdn-apple.com/jsapi/1.latest/apple-pay-sdk.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 500px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    h2 { margin-top: 0; color: #333; }
    button {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .btn-primary {
      background: #0070ba;
      color: white;
    }
    .btn-primary:hover:not(:disabled) { background: #005ea6; }
    .status {
      padding: 12px;
      border-radius: 8px;
      margin-top: 16px;
      font-size: 14px;
    }
    .status.info { background: #e3f2fd; color: #1565c0; }
    .status.success { background: #e8f5e9; color: #2e7d32; }
    .status.error { background: #ffebee; color: #c62828; }
    .status.warn { background: #fff3e0; color: #e65100; }
    .hidden { display: none; }
    .loader {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #fff;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    #config-section input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      margin-bottom: 10px;
      font-size: 14px;
    }
    pre {
      background: #f5f5f5;
      padding: 12px;
      border-radius: 6px;
      overflow: auto;
      font-size: 12px;
      max-height: 400px;
    }
    /* Apple Pay button styling */
    #applepay-container {
      margin-top: 16px;
    }
    apple-pay-button {
      --apple-pay-button-width: 100%;
      --apple-pay-button-height: 48px;
      --apple-pay-button-border-radius: 8px;
      --apple-pay-button-padding: 0;
      display: block;
      cursor: pointer;
    }
    .note {
      background: #fff8e1;
      border: 1px solid #ffecb3;
      border-radius: 8px;
      padding: 12px;
      font-size: 13px;
      color: #795548;
      margin-bottom: 16px;
    }
    .step-label {
      display: inline-block;
      background: #e3f2fd;
      color: #1565c0;
      font-size: 11px;
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 4px;
      margin-bottom: 8px;
    }
  </style>
</head>
<body>

  <!-- ==================== OVERVIEW ==================== -->
  <div class="card">
    <h2>Apple Pay Integration Reference</h2>
    <p style="color: #666; font-size: 14px; margin: 0;">
      This file demonstrates how a <strong>Next.js storefront</strong> should integrate
      Apple Pay checkout using the Saleor PayPal custom app. It follows the same
      Saleor GraphQL mutation pattern as the ACDC flow (index.html) but with
      Apple Pay's unique multi-step flow.
    </p>
  </div>

  <!-- ==================== CONFIG ==================== -->
  <div class="card" id="config-section">
    <h2>Configuration</h2>
    <label>Saleor API URL</label>
    <input type="text" id="saleorApi" value="https://api-aeroexhaust.wsm-dev.com/graphql/">
    <label>Saleor Token</label>
    <input type="text" id="saleorToken" value="">
    <label>Checkout ID</label>
    <input type="text" id="checkoutId" value="">
    <label>Amount (must match checkout total)</label>
    <input type="number" id="amount" value="100.00" step="0.01">
    <label>Saleor User ID</label>
    <input type="text" id="saleorUserId" value="">
    <button class="btn-primary" id="initBtn" onclick="initializeGateway()">
      Initialize Payment Gateway
    </button>
    <div id="initStatus"></div>
  </div>

  <!-- ==================== APPLE PAY BUTTON ==================== -->
  <div class="card hidden" id="applepay-section">
    <h2>Apple Pay</h2>
    <div class="note">
      <strong>Requirements:</strong> Safari browser (or latest Apple Pay SDK on other browsers),
      macOS 10.14.1+ / iOS 12.1+, and an Apple Pay-enabled device with a card in the wallet.
      Domain must be registered with PayPal for Apple Pay.
    </div>
    <div id="applepay-status"></div>
    <div id="applepay-container"></div>
  </div>

  <!-- ==================== RESULT ==================== -->
  <div class="card hidden" id="result-section">
    <h2>Payment Result</h2>
    <pre id="resultJson"></pre>
  </div>

  <!-- ==================== FLOW REFERENCE ==================== -->
  <div class="card">
    <h2>Flow Reference</h2>
    <pre style="font-size: 11px; line-height: 1.5; white-space: pre-wrap;">
Apple Pay Flow (differs from ACDC):

1. paymentGatewayInitialize
   → Returns: clientId, merchantId, applePay readiness

2. Load PayPal SDK (components=applepay)
   + Apple Pay JS SDK (already loaded in &lt;head&gt;)

3. paypal.Applepay().config()
   → Returns: countryCode, merchantCapabilities, supportedNetworks
   → If eligible, render Apple Pay button

4. User clicks Apple Pay button
   → new ApplePaySession(4, paymentRequest)
   → session.begin() — shows payment sheet

5. onvalidatemerchant callback
   → paypal.Applepay().validateMerchant()
   → session.completeMerchantValidation()
   (No Saleor call needed — PayPal SDK handles this)

6. onpaymentauthorized callback (user authorized with Face ID / Touch ID)
   → Saleor transactionInitialize (paymentMethodType: "apple_pay")
     Backend creates PayPal order WITHOUT payment_source
     Returns: orderId (pspReference)

   → paypal.Applepay().confirmOrder({ orderId, token, billingContact })
     Attaches Apple Pay token to the PayPal order

   → Saleor transactionProcess
     Backend captures the order

   → session.completePayment(STATUS_SUCCESS)

Key difference from ACDC:
- ACDC: PayPal SDK calls createOrder callback → order created with payment_source.card
- Apple Pay: Order created FIRST (no payment_source), then confirmOrder() attaches token
    </pre>
  </div>

  <script>
    // ============================================
    // STATE
    // ============================================
    let paypalConfig = null;    // From PaymentGatewayInitialize
    let applepayInstance = null; // PayPal Apple Pay SDK instance
    let applepayConfig = null;  // From paypal.Applepay().config()
    let transactionId = null;

    // ============================================
    // GRAPHQL MUTATIONS (same as ACDC flow)
    // ============================================
    const PAYMENT_GATEWAY_INITIALIZE = `
      mutation PaymentGatewayInitialize($checkoutId: ID!, $amount: PositiveDecimal!, $data: JSON) {
        paymentGatewayInitialize(
          id: $checkoutId
          amount: $amount
          paymentGateways: [{
            id: "saleor.app.payment.paypal"
            data: $data
          }]
        ) {
          gatewayConfigs {
            id
            data
            errors { field message }
          }
          errors { field message }
        }
      }
    `;

    const TRANSACTION_INITIALIZE = `
      mutation TransactionInitialize($checkoutId: ID!, $amount: PositiveDecimal!, $data: JSON!) {
        transactionInitialize(
          id: $checkoutId
          amount: $amount
          paymentGateway: {
            id: "saleor.app.payment.paypal"
            data: $data
          }
        ) {
          transactionEvent {
            type
            message
          }
          transaction {
            id
            pspReference
          }
          data
          errors { field message code }
        }
      }
    `;

    const TRANSACTION_PROCESS = `
      mutation TransactionProcess($transactionId: ID!, $data: JSON) {
        transactionProcess(
          id: $transactionId
          data: $data
        ) {
          transactionEvent {
            type
            message
          }
          transaction {
            id
            pspReference
            authorizedAmount { amount currency }
            chargedAmount { amount currency }
          }
          data
          errors { field message code }
        }
      }
    `;

    // ============================================
    // HELPERS
    // ============================================
    function getConfig() {
      return {
        saleorApi: document.getElementById('saleorApi').value,
        saleorToken: document.getElementById('saleorToken').value,
        checkoutId: document.getElementById('checkoutId').value,
        amount: parseFloat(document.getElementById('amount').value),
        saleorUserId: document.getElementById('saleorUserId').value,
      };
    }

    async function graphqlRequest(query, variables) {
      const config = getConfig();
      const res = await fetch(config.saleorApi, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${config.saleorToken}`,
        },
        body: JSON.stringify({ query, variables }),
      });
      return res.json();
    }

    function showStatus(elementId, message, type = 'info') {
      const el = document.getElementById(elementId);
      el.className = `status ${type}`;
      el.innerHTML = message;
      el.classList.remove('hidden');
    }

    function generateIdempotencyKey() {
      return `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    }

    function parseSaleorJson(value) {
      if (value == null) return null;
      if (typeof value === 'object') return value;
      if (typeof value === 'string') {
        try {
          const parsed = JSON.parse(value);
          if (typeof parsed === 'string') {
            try { return JSON.parse(parsed); } catch (_) { return parsed; }
          }
          return parsed;
        } catch (_) {
          return value;
        }
      }
      return value;
    }

    function showResult(data) {
      document.getElementById('result-section').classList.remove('hidden');
      document.getElementById('resultJson').textContent = JSON.stringify(data, null, 2);
    }

    // ============================================
    // STEP 1 — INITIALIZE PAYMENT GATEWAY
    // Same as ACDC: call PaymentGatewayInitialize to get
    // PayPal clientId, merchantId, and applePay readiness.
    // ============================================
    async function initializeGateway() {
      const btn = document.getElementById('initBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="loader"></span>Initializing...';

      try {
        const config = getConfig();
        showStatus('initStatus', 'Calling PaymentGatewayInitialize...', 'info');

        const result = await graphqlRequest(PAYMENT_GATEWAY_INITIALIZE, {
          checkoutId: config.checkoutId,
          amount: config.amount,
          data: { saleorUserId: config.saleorUserId },
        });

        console.log('[Step 1] PaymentGatewayInitialize response:', JSON.stringify(result, null, 2));

        if (result.errors || result.data?.paymentGatewayInitialize?.errors?.length) {
          throw new Error(JSON.stringify(result.errors || result.data.paymentGatewayInitialize.errors));
        }

        const gatewayConfig = result.data.paymentGatewayInitialize.gatewayConfigs.find(
          (g) => g.id === 'saleor.app.payment.paypal',
        );

        if (!gatewayConfig) throw new Error('PayPal gateway config not found');

        paypalConfig = parseSaleorJson(gatewayConfig.data);
        console.log('[Step 1] PayPal config:', paypalConfig);

        // Check Apple Pay readiness from backend
        const applePayReady = paypalConfig.paymentMethodReadiness?.applePay;
        console.log('[Step 1] Apple Pay readiness:', applePayReady);

        if (!applePayReady) {
          showStatus('initStatus', 'Apple Pay is not enabled for this merchant. Check onboarding status.', 'warn');
          return;
        }

        showStatus('initStatus', 'Gateway initialized. Loading Apple Pay SDK...', 'success');

        // Load PayPal SDK with applepay component
        await loadPayPalSDK();

        // Check Apple Pay eligibility and render button
        await checkApplePayEligibility();

      } catch (error) {
        console.error('[Step 1] Error:', error);
        showStatus('initStatus', 'Error: ' + error.message, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'Initialize Payment Gateway';
      }
    }

    // ============================================
    // STEP 2 — LOAD PAYPAL SDK (components=applepay)
    // Note: Apple Pay JS SDK is loaded in <head> tag.
    // ============================================
    function loadPayPalSDK() {
      return new Promise((resolve, reject) => {
        const existing = document.getElementById('paypal-sdk');
        if (existing) existing.remove();

        const script = document.createElement('script');
        script.id = 'paypal-sdk';

        // PayPal SDK params for Apple Pay
        // merchant-id is the sub-merchant (seller) PayPal merchant ID
        const params = new URLSearchParams({
          'client-id': paypalConfig.paypalClientId,
          components: 'applepay',
          intent: 'capture',
          currency: 'USD',
        });

        // Add merchant-id if available (required for partner/marketplace model)
        if (paypalConfig.merchantId) {
          params.set('merchant-id', paypalConfig.merchantId);
        }

        script.src = 'https://www.paypal.com/sdk/js?' + params.toString();

        script.onload = () => {
          console.log('[Step 2] PayPal SDK loaded with applepay component');
          resolve();
        };
        script.onerror = () => reject(new Error('Failed to load PayPal SDK'));

        document.head.appendChild(script);
      });
    }

    // ============================================
    // STEP 3 — CHECK ELIGIBILITY & RENDER BUTTON
    // Uses paypal.Applepay().config() and
    // ApplePaySession.canMakePayments()
    // ============================================
    async function checkApplePayEligibility() {
      const section = document.getElementById('applepay-section');
      section.classList.remove('hidden');

      // Check 1: Device supports Apple Pay
      if (!window.ApplePaySession) {
        showStatus('applepay-status', 'This device/browser does not support Apple Pay. Safari on macOS 10.14.1+ or iOS 12.1+ required.', 'error');
        console.error('[Step 3] ApplePaySession not available');
        return;
      }

      if (!ApplePaySession.canMakePayments()) {
        showStatus('applepay-status', 'This device cannot make Apple Pay payments. Ensure a card is added to the Apple Wallet.', 'error');
        console.error('[Step 3] canMakePayments() returned false');
        return;
      }

      // Check 2: PayPal Apple Pay config
      if (!window.paypal?.Applepay) {
        showStatus('applepay-status', 'PayPal Apple Pay SDK not available. Ensure components=applepay is in the SDK script.', 'error');
        console.error('[Step 3] paypal.Applepay not available');
        return;
      }

      try {
        applepayInstance = paypal.Applepay();
        applepayConfig = await applepayInstance.config();

        console.log('[Step 3] Apple Pay config:', applepayConfig);

        if (!applepayConfig.isEligible) {
          showStatus('applepay-status', 'Apple Pay is not eligible for this merchant/configuration.', 'warn');
          return;
        }

        // Render the Apple Pay button
        showStatus('applepay-status', 'Apple Pay is available. Click the button below to pay.', 'success');

        document.getElementById('applepay-container').innerHTML =
          '<apple-pay-button id="btn-applepay" buttonstyle="black" type="buy" locale="en" onclick="onApplePayClicked()"></apple-pay-button>';

        console.log('[Step 3] Apple Pay button rendered');

      } catch (error) {
        console.error('[Step 3] Apple Pay config error:', error);
        showStatus('applepay-status', 'Error checking Apple Pay eligibility: ' + error.message, 'error');
      }
    }

    // ============================================
    // STEP 4 — USER CLICKS APPLE PAY BUTTON
    // Must create ApplePaySession inside a gesture handler.
    // ============================================
    function onApplePayClicked() {
      console.log('[Step 4] Apple Pay button clicked');

      const config = getConfig();

      // Build the Apple Pay payment request using config from paypal.Applepay().config()
      const paymentRequest = {
        countryCode: applepayConfig.countryCode,
        merchantCapabilities: applepayConfig.merchantCapabilities,
        supportedNetworks: applepayConfig.supportedNetworks,
        currencyCode: 'USD',
        requiredBillingContactFields: ['postalAddress'],
        requiredShippingContactFields: ['name', 'phone', 'email', 'postalAddress'],
        total: {
          label: 'Store Checkout',
          type: 'final',
          amount: String(config.amount),
        },
      };

      console.log('[Step 4] ApplePaySession paymentRequest:', paymentRequest);

      // Create a new session for each payment attempt (Apple requirement)
      const session = new ApplePaySession(4, paymentRequest);

      // ============================================
      // STEP 5 — MERCHANT VALIDATION
      // PayPal SDK handles this — no Saleor call needed.
      // ============================================
      session.onvalidatemerchant = async (event) => {
        console.log('[Step 5] onvalidatemerchant:', event.validationURL);
        showStatus('applepay-status', 'Validating merchant with PayPal...', 'info');

        try {
          const validateResult = await applepayInstance.validateMerchant({
            validationUrl: event.validationURL,
            displayName: 'Store Checkout',
          });

          console.log('[Step 5] Merchant validated:', validateResult);
          session.completeMerchantValidation(validateResult.merchantSession);

        } catch (error) {
          console.error('[Step 5] Merchant validation failed:', error);
          showStatus('applepay-status', 'Merchant validation failed: ' + error.message, 'error');
          session.abort();
        }
      };

      // ============================================
      // STEP 6 — PAYMENT AUTHORIZED
      // User authorized with Face ID / Touch ID.
      // Now: create order → confirmOrder → capture.
      // ============================================
      session.onpaymentauthorized = async (event) => {
        console.log('[Step 6] onpaymentauthorized — user authorized payment');
        console.log('[Step 6] Billing contact:', event.payment.billingContact);
        console.log('[Step 6] Shipping contact:', event.payment.shippingContact);
        console.log('[Step 6] Apple Pay token:', event.payment.token);

        showStatus('applepay-status', 'Payment authorized. Creating order...', 'info');

        try {
          // ---- Step 6a: Create PayPal order via Saleor transactionInitialize ----
          // Backend creates order WITHOUT payment_source (Apple Pay specific).
          const initData = {
            paymentMethodType: 'apple_pay',
            saleorUserId: config.saleorUserId,
            idempotencyKey: generateIdempotencyKey(),
          };

          console.log('[Step 6a] TransactionInitialize data:', initData);

          const initResult = await graphqlRequest(TRANSACTION_INITIALIZE, {
            checkoutId: config.checkoutId,
            amount: config.amount,
            data: initData,
          });

          console.log('[Step 6a] TransactionInitialize response:', JSON.stringify(initResult, null, 2));

          if (initResult.errors || initResult.data?.transactionInitialize?.errors?.length) {
            throw new Error(JSON.stringify(initResult.errors || initResult.data.transactionInitialize.errors));
          }

          const txData = initResult.data.transactionInitialize;
          transactionId = txData.transaction?.id;

          // Extract PayPal order ID from response
          const responseData = parseSaleorJson(txData.data);
          const paypalOrderId =
            responseData?.paypal_order_id ||
            responseData?.paypalOrderId ||
            txData.transaction?.pspReference ||
            responseData?.data?.paypal_order_id ||
            responseData?.pspReference;

          if (!paypalOrderId) {
            throw new Error('PayPal Order ID not found in transactionInitialize response');
          }

          console.log('[Step 6a] PayPal Order ID:', paypalOrderId);

          // ---- Step 6b: Confirm order with Apple Pay token ----
          // This attaches the Apple Pay token to the PayPal order.
          showStatus('applepay-status', 'Confirming order with Apple Pay token...', 'info');

          console.log('[Step 6b] Calling confirmOrder with orderId:', paypalOrderId);

          const confirmResult = await applepayInstance.confirmOrder({
            orderId: paypalOrderId,
            token: event.payment.token,
            billingContact: event.payment.billingContact,
          });

          console.log('[Step 6b] confirmOrder result:', confirmResult);

          // ---- Step 6c: Capture via Saleor transactionProcess ----
          showStatus('applepay-status', 'Capturing payment...', 'info');

          console.log('[Step 6c] TransactionProcess — capturing order');

          const processResult = await graphqlRequest(TRANSACTION_PROCESS, {
            transactionId: transactionId,
            data: { paypalOrderId: paypalOrderId },
          });

          console.log('[Step 6c] TransactionProcess response:', JSON.stringify(processResult, null, 2));

          if (processResult.errors || processResult.data?.transactionProcess?.errors?.length) {
            throw new Error(JSON.stringify(processResult.errors || processResult.data.transactionProcess.errors));
          }

          const processData = processResult.data.transactionProcess;
          const eventType = processData.transactionEvent?.type || 'UNKNOWN';

          // ---- Complete Apple Pay session ----
          session.completePayment(ApplePaySession.STATUS_SUCCESS);

          if (eventType === 'CHARGE_SUCCESS') {
            showStatus('applepay-status', 'Payment successful!', 'success');
          } else if (eventType === 'AUTHORIZATION_SUCCESS') {
            showStatus('applepay-status', 'Payment authorized!', 'success');
          } else {
            showStatus('applepay-status', 'Status: ' + eventType, 'info');
          }

          showResult(processData);

        } catch (error) {
          console.error('[Step 6] Payment error:', error);
          session.completePayment(ApplePaySession.STATUS_FAILURE);
          showStatus('applepay-status', 'Payment failed: ' + error.message, 'error');
        }
      };

      // Handle cancel
      session.oncancel = () => {
        console.log('[Apple Pay] Session cancelled by user');
        showStatus('applepay-status', 'Payment cancelled.', 'warn');
      };

      // Show the Apple Pay payment sheet
      session.begin();
      console.log('[Step 4] Apple Pay session started — payment sheet shown');
    }
  </script>
</body>
</html>
