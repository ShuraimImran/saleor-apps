import { Box, Text, Button, Input } from "@saleor/macaw-ui";
import { NextPage } from "next";
import * as React from "react";
import { State } from "country-state-city";
import { trpcClient } from "@/modules/trpc/trpc-client";
import { CreateTaxRateRule, TaxRateRule, SupportedCountry } from "@/modules/tax-rates/tax-rate-schema";

const ConfigurationPage: NextPage = () => {
  // Form state
  const [formData, setFormData] = React.useState<CreateTaxRateRule>({
    name: "",
    country: "US" as SupportedCountry,
    state: null,
    postalCodePattern: null,
    taxRate: 0,
    enabled: true,
    priority: 100,
  });
  
  // UI state
  const [isEditing, setIsEditing] = React.useState(false);
  const [editingId, setEditingId] = React.useState<string | null>(null);
  
  // tRPC queries
  const { data: taxRates = [], refetch: refetchTaxRates } = trpcClient.taxRates.getAllRates.useQuery();
  const createMutation = trpcClient.taxRates.createRate.useMutation({
    onSuccess: () => {
      refetchTaxRates();
      resetForm();
    },
  });
  const updateMutation = trpcClient.taxRates.updateRate.useMutation({
    onSuccess: () => {
      refetchTaxRates();
      resetForm();
    },
  });
  const deleteMutation = trpcClient.taxRates.deleteRate.useMutation({
    onSuccess: () => {
      refetchTaxRates();
    },
  });

  const resetForm = () => {
    setFormData({
      name: "",
      country: "US" as SupportedCountry,
      state: null,
      postalCodePattern: null,
      taxRate: 0,
      enabled: true,
      priority: 100,
    });
    setIsEditing(false);
    setEditingId(null);
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (isEditing && editingId) {
      // Update existing rate
      await updateMutation.mutateAsync({
        id: editingId as any,
        ...formData,
      });
    } else {
      // Create new rate
      await createMutation.mutateAsync(formData);
    }
  };

  const handleEdit = (rate: TaxRateRule) => {
    setFormData({
      name: rate.name,
      country: rate.country,
      state: rate.state,
      postalCodePattern: rate.postalCodePattern,
      taxRate: rate.taxRate,
      enabled: rate.enabled,
      priority: rate.priority,
    });
    setIsEditing(true);
    setEditingId(rate.id);
  };

  const handleDelete = async (id: string) => {
    if (confirm("Are you sure you want to delete this tax rate?")) {
      await deleteMutation.mutateAsync({ id: id as any });
    }
  };

  // Available countries
  const countries = [
    { name: "United States", isoCode: "US" as SupportedCountry },
    { name: "Canada", isoCode: "CA" as SupportedCountry },
    { name: "Mexico", isoCode: "MX" as SupportedCountry },
  ];

  // Get states for selected country
  const states = formData.country ? State.getStatesOfCountry(formData.country) : [];

  const handleCountryChange = (e: React.ChangeEvent<HTMLSelectElement>) => {
    setFormData(prev => ({
      ...prev,
      country: e.target.value as SupportedCountry,
      state: null, // Reset state when country changes
    }));
  };

  const handleStateChange = (e: React.ChangeEvent<HTMLSelectElement>) => {
    setFormData(prev => ({
      ...prev,
      state: e.target.value || null,
    }));
  };

  return (
    <Box padding={8} style={{ maxWidth: "800px", margin: "0 auto" }}>
      {/* Header */}
      <Box marginBottom={8}>
        <Text size={7} fontWeight="bold" marginBottom={2}>
          Flat Tax Configuration
        </Text>
        <Text size={3} color="default2">
          Configure tax rates by country/state and postal codes.
        </Text>
      </Box>

      {/* Main Form */}
      <Box
        padding={8}
        borderStyle="solid"
        borderWidth={1}
        borderColor="default1"
        borderRadius={4}
        backgroundColor="default1"
        display="flex"
        flexDirection="column"
        gap={6}
      >
        {/* Country/State Tax Rates Section */}
        <Box>
          <Text size={5} fontWeight="bold" marginBottom={4}>
            Country & State Tax Rates
          </Text>

          {/* Select Country */}
          <Box display="flex" flexDirection="column" gap={3} marginBottom={4}>
            <Text size={4} fontWeight="medium">
              Select Country
            </Text>
            <select
              value={country}
              onChange={handleCountryChange}
              style={{
                padding: "12px",
                fontSize: "14px",
                borderRadius: "4px",
                border: "1px solid #ccc",
                backgroundColor: "white",
                cursor: "pointer",
              }}
            >
              <option value="">Select Country</option>
              {countries.map((c) => (
                <option key={c.isoCode} value={c.isoCode}>
                  {c.name}
                </option>
              ))}
            </select>
          </Box>

          {/* Select State/Province - Only show when country is selected */}
          {country && (
            <Box display="flex" flexDirection="column" gap={3} marginBottom={4}>
              <Text size={4} fontWeight="medium">
                Select State/Province
              </Text>
              <select
                value={state}
                onChange={handleStateChange}
                style={{
                  padding: "12px",
                  fontSize: "14px",
                  borderRadius: "4px",
                  border: "1px solid #ccc",
                  backgroundColor: "white",
                  cursor: "pointer",
                }}
              >
                <option value="">Select State</option>
                {states.map((s) => (
                  <option key={s.isoCode} value={s.isoCode}>
                    {s.name}
                  </option>
                ))}
              </select>
            </Box>
          )}

          {/* Tax Rate and Enable - Only show when state is selected */}
          {country && state && (
            <Box display="flex" flexDirection="column" gap={3}>
              <Text size={4} fontWeight="medium">
                Tax Rate
              </Text>
              <Box display="flex" alignItems="center" gap={4}>
                <Box width={32}>
                  <Input
                    type="number"
                    value={taxRate}
                    onChange={(e) => setTaxRate(e.target.value)}
                    placeholder="9.5"
                  />
                </Box>
                <Text size={3}>%</Text>
              </Box>

              <Button
                variant="primary"
                size="medium"
                onClick={handleSaveConfiguration}
                disabled={!taxRate}
                style={{ marginTop: "8px", width: "fit-content" }}
              >
                Add Tax Rate
              </Button>
            </Box>
          )}
        </Box>

        {/* Divider */}
        <Box
          borderTopStyle="solid"
          borderTopWidth={1}
          borderColor="default1"
          marginY={4}
        />

        {/* Postal Code Tax Rates Section */}
        <Box>
          <Text size={5} fontWeight="bold" marginBottom={4}>
            Postal Code Tax Rates
          </Text>

          <Box display="flex" flexDirection="column" gap={3}>
            <Text size={4} fontWeight="medium">
              Postal Code
            </Text>
            <Box width={48}>
              <Input
                value={postalCode}
                onChange={(e) => setPostalCode(e.target.value)}
                placeholder="90210"
              />
            </Box>

            <Text size={4} fontWeight="medium">
              Tax Rate
            </Text>
            <Box display="flex" alignItems="center" gap={4}>
              <Box width={32}>
                <Input
                  type="number"
                  value={postalTaxRate}
                  onChange={(e) => setPostalTaxRate(e.target.value)}
                  placeholder="8.5"
                />
              </Box>
              <Text size={3}>%</Text>
            </Box>

            <Button
              variant="primary"
              size="medium"
              onClick={handleSaveConfiguration}
              disabled={!postalCode || !postalTaxRate}
              style={{ marginTop: "8px", width: "fit-content" }}
            >
              Add Postal Code Rate
            </Button>
          </Box>
        </Box>
      </Box>
    </Box>
  );
};

export default ConfigurationPage;
